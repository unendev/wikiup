# 任务：切换非流式响应 - 紧急来源追溯

## 上下文
- **任务时间**：2025-10-27
- **优先级**：高（紧急）
- **目标**：修复无法追溯来源的问题，改为非流式响应模式

## 问题分析
- 当前系统使用WebSocket流式响应，导致sources信息在答案完成后才发送
- 前端默认 `stream: true`，无法同时展示答案+来源
- 后端已实现非流式模式，仅需前端切换参数

## 执行计划

### 改动点 1：前端流式参数开关
**文件**：`frontend/src/App.vue`
**行号**：165
**改动**：
```javascript
// 改前
stream: true,  // 启用流式响应

// 改后
stream: false,  // 改为非流式响应
```

**理由**：
- 一行代码改动，立即生效
- 后端WebSocket已支持非流式模式
- 前端UI完整支持sources展示

### 验证点 1：非流式接收处理
**文件**：`frontend/src/App.vue`
**行号**：76-83
**当前代码**：
```typescript
if (response.type === 'answer') {
  // 完整回答
  isLoading.value = false;
  messages.value.push({ 
    role: 'ai', 
    content: response.content,
    sources: response.sources || []
  });
}
```
**状态**：✅ 已验证，无需改动

### 验证点 2：ChatMessage组件sources渲染
**文件**：`frontend/src/components/ChatMessage.vue`
**功能**：
- 第23-27行：检查sources有效性
- 第81-102行：渲染sources参考资料卡片
- 显示来源文件、章节、相关度、内容详情

**状态**：✅ 已验证，功能完整

## 后端支持情况

### WebSocket消息处理
**文件**：`backend/src/main/java/com/example/ragservice/endpoint/ChatEndpoint.java`

**非流式模式** (L126-165)：
- 检查 `stream: false`
- 调用 `ragService.getAnswer()` 返回 `Mono<ChatResponse>`
- 响应格式：`{type: "answer", content: "...", sources: [...]}`

**流式模式** (L69-125)：
- 检查 `stream: true`
- 调用 `ragService.getAnswerStream()` 分块发送答案
- 完成时发送 `{type: "done", sources: [...]}`

### 数据返回结构
```json
{
  "type": "answer",
  "content": "完整答案文本",
  "sources": [
    {
      "title": "文档标题",
      "source": "来源文件名",
      "path": "文件路径",
      "score": 0.95
    }
  ]
}
```

## 改动影响分析

| 组件 | 改动 | 影响 | 风险 |
|-----|------|------|------|
| 前端UI | stream参数 | 用户体验变为一次性返回 | 低 |
| 后端逻辑 | 无 | 已支持非流式模式 | 无 |
| 数据结构 | 无 | 完全兼容 | 无 |
| 网络传输 | 改为等待完整响应 | 响应时间可能 +0.5-1s | 低 |

## 预期效果

### 改前（流式模式）
```
用户: 牛有什么用？
AI: (逐字显示) 牛是一种...可饲养...生物...
    等待流完成...
Sources: (最后显示，可能错过)
```

### 改后（非流式模式）
```
用户: 牛有什么用？
AI: 牛是一种可饲养的生物...（完整显示）
Sources: 立即显示参考资料
```

## 测试清单

- [ ] 修改 frontend/src/App.vue L165
- [ ] 前端项目编译/热重载
- [ ] WebSocket连接正常
- [ ] 发送测试问题
- [ ] 验证响应格式含sources
- [ ] 验证sources正确渲染
- [ ] 多个问题联续测试
- [ ] 检查浏览器Console无错误

## 回滚方案

若出现问题，只需：
1. 将 `stream: false` 改回 `stream: true`
2. 重新编译前端
3. 测试确认

## 完成标记

✅ **改动完成时间**：2025-10-27
✅ **改动内容**：1行代码修改
✅ **测试状态**：待执行
