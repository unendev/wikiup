# WikiUp后端优化实施计划

## 1. 概述

本文档详细描述WikiUp后端系统的优化实施计划，基于已有的架构设计和技术栈，通过分阶段实施提升系统可维护性、安全性和可扩展性。计划优先考虑代码质量和架构清晰度，为实习项目展示提供良好支持。

## 2. 背景

WikiUp是一个基于Spring Boot和Vue的企业级知识库检索平台，核心实现了RAG(检索增强生成)架构。现需要对后端系统进行针对性优化，重点提升系统架构和代码质量，为面试和实习申请提供有力支持。

## 3. 目标

1. 提升系统架构的清晰度和可维护性
2. 改进代码组织结构，便于展示和技术交流
3. 增强系统安全性，完善认证与授权机制
4. 为未来的微服务架构转型做准备

## 4. 实施任务与进度跟踪

### 4.1 架构优化（优先级：P0）

#### 4.1.1 分层架构完善
- **详细设计**：
  - Controller层实现RESTful API规范，处理请求参数验证和响应封装
  - DTO层实现数据传输对象，隔离视图模型与领域模型
  - Repository层抽象数据访问操作，提供统一的CRUD接口
  - Domain层实现核心业务逻辑，保持业务规则的独立性
- **任务清单**：
  - [x] T3-1: 分析现有代码结构，识别需要重构的组件（1人日）
  - [x] T3-2: 设计Controller层接口规范，定义统一响应格式（2人日）
  - [x] T3-3: 实现基础DTO类和转换器（1人日）
  - [x] T3-4: 设计并实现Repository层接口（2人日）
  - [x] T3-5: 创建Domain模型类，迁移业务逻辑（3人日）
  - [x] T3-6: 编写单元测试覆盖重构代码（2人日）
  - [ ] T3-7: 进行代码审查，解决潜在问题（1人日）
- **技术选型**：
  - Spring MVC用于Controller层实现
  - ModelMapper用于DTO转换
  - Spring Data用于Repository层抽象
- **预期成果**：
  - 代码结构清晰，职责分明
  - 维护成本降低，可扩展性提高
  - 测试覆盖率提升至80%以上
- **负责人**: TBD
- **截止日期**: TBD

#### 4.1.2 设计模式应用
- **详细设计**：
  - 工厂模式：用于创建不同类型的嵌入模型、分块器等
  - 策略模式：用于实现不同的文本分块策略
  - 观察者模式：用于文档处理状态通知
  - 装饰器模式：用于增强核心服务功能
- **任务清单**：
  - [x] T4-1: 设计并实现嵌入模型工厂（1人日）
  - [x] T4-2: 设计并实现文本分块策略（2人日）
  - [x] T4-3: 设计并实现文档处理事件系统（1人日）
  - [x] T4-4: 设计并实现服务装饰器（1人日）
  - [x] T4-5: 重构现有代码使用新设计模式（2人日）
  - [x] T4-6: 编写单元测试验证设计模式实现（1人日）
  - [ ] T4-7: 进行代码审查和优化（1人日）
- **技术选型**：
  - 工厂模式：EmbeddingModelFactory
  - 策略模式：TextChunker接口
  - 观察者模式：Spring ApplicationEvent
  - 装饰器模式：ServiceDecorator接口
- **预期成果**：
  - 代码复用性提高，扩展更加灵活
  - 新功能添加更加便捷
  - 系统间松耦合，单元可独立测试
- **负责人**: TBD
- **截止日期**: TBD

### 4.2 安全加固（优先级：P1）

#### 4.2.1 认证授权体系
- **详细设计**：
  - 实现JWT令牌认证
  - 基于角色的访问控制(RBAC)
  - 实现细粒度API权限控制
- **任务清单**：
  - [x] T1-1: 集成Spring Security框架（1人日）
  - [x] T1-2: 实现JWT令牌生成和验证（1人日）
  - [x] T1-3: 设计RBAC权限模型（1人日）
  - [x] T1-4: 实现用户认证流程（1人日）
  - [x] T1-5: 实现API权限控制（1人日）
  - [x] T1-6: 添加登录失败保护机制（0.5人日）
  - [x] T1-7: 实现会话管理（0.5人日）
  - [x] T1-8: 编写安全测试用例（1人日）
  - [x] T1-9: 进行安全审查和优化（1人日）
- **技术选型**：
  - Spring Security
  - JJWT库
  - 自定义AccessDecisionVoter
- **预期成果**：
  - 安全认证机制完善
  - 细粒度权限控制
  - 防止未授权访问
- **负责人**: TBD
- **截止日期**: TBD

#### 4.2.2 API限流与保护 (简化版)
- **详细设计**：
  - 实现基于内存的请求限流
  - 实现基于用户的限流
  - 配置分级限流策略
- **任务清单**：
  - [ ] T2-1: 集成Bucket4j令牌桶算法（1人日）
  - [ ] T2-2: 实现IP限流拦截器（1人日）
  - [ ] T2-3: 实现用户限流拦截器（1人日）
  - [ ] T2-4: 设计分级限流策略（1人日）
  - [ ] T2-5: 添加限流异常处理（1人日）
- **技术选型**：
  - Bucket4j
  - Spring AOP
- **预期成果**：
  - 防止DoS攻击
  - 保护系统资源不被滥用
  - 确保关键API可用性
- **负责人**: TBD
- **截止日期**: TBD

### 4.3 容器化部署（优先级：P2）

- **详细设计**：
  - 多阶段Dockerfile构建
  - Docker Compose服务编排
  - 容器资源限制与健康检查
  - 非root用户运行提升安全性
- **任务清单**：
  - [ ] T5-1: 编写多阶段Dockerfile（1人日）
  - [ ] T5-2: 配置Docker Compose文件（1人日）
  - [ ] T5-3: 实现容器健康检查脚本（0.5人日）
  - [ ] T5-4: 配置容器资源限制（0.5人日）
  - [ ] T5-5: 实现非root用户运行（0.5人日）
  - [ ] T5-6: 编写自动化部署脚本（1人日）
  - [ ] T5-7: 测试部署流程（1人日）
  - [ ] T5-8: 编写部署文档（0.5人日）
- **技术选型**：
  - Docker多阶段构建
  - Docker Compose
  - 健康检查脚本
- **预期成果**：
  - 部署过程标准化和自动化
  - 开发环境与生产环境一致性
  - 资源使用更加高效
- **负责人**: TBD
- **截止日期**: TBD

### 4.4 监控与可观测性（优先级：P2）

- **详细设计**：
  - 集成Spring Boot Actuator暴露系统指标
  - 添加Prometheus指标收集
  - 实现自定义业务指标监控
  - 健康检查端点与自动恢复机制
- **任务清单**：
  - [ ] T6-1: 配置Spring Boot Actuator（0.5人日）
  - [ ] T6-2: 集成Micrometer Prometheus Registry（0.5人日）
  - [ ] T6-3: 配置健康检查端点（0.5人日）
  - [ ] T6-4: 实现自定义业务指标收集器（1人日）
  - [ ] T6-5: 部署Prometheus服务器（0.5人日）
  - [ ] T6-6: 配置Grafana仪表盘（1人日）
  - [ ] T6-7: 实现监控告警规则（0.5人日）
  - [ ] T6-8: 添加自动恢复机制（1人日）
- **技术选型**：
  - Spring Boot Actuator
  - Micrometer
  - Prometheus
  - Grafana
- **预期成果**：
  - 系统运行状况可视化
  - 性能瓶颈早期发现
  - 问题快速定位和响应
- **负责人**: TBD
- **截止日期**: TBD

### 4.5 性能优化（优先级：P3 - 按需实施）

#### 4.5.1 并发与异步处理
- **详细设计**：
  - 使用CompletableFuture实现并行文档处理
  - 自定义线程池管理异步任务
  - 引入RabbitMQ处理异步任务队列
- **任务清单**：
  - [ ] T7-1: 设计自定义线程池配置（0.5人日）
  - [ ] T7-2: 实现CompletableFuture异步处理框架（1人日）
  - [ ] T7-3: 重构文档处理逻辑使用并行处理（2人日）
  - [ ] T7-4: 安装配置RabbitMQ（0.5人日）
  - [ ] T7-5: 实现消息生产者服务（1人日）
  - [ ] T7-6: 实现消息消费者服务（1人日）
  - [ ] T7-7: 添加失败重试和异常处理机制（1人日）
  - [ ] T7-8: 进行性能测试和优化（1人日）
- **技术选型**：
  - CompletableFuture API
  - ThreadPoolTaskExecutor
  - Spring AMQP
- **预期成果**：
  - 文档处理并行化，性能提升5倍
  - 系统响应性提高，不阻塞主线程
  - 任务可靠执行，支持失败重试
- **负责人**: TBD
- **截止日期**: TBD

### 4.6 缓存优化（优先级：P3 - 按需实施）

- **详细设计**：
  - 实现多级缓存策略
  - 本地缓存（Caffeine）用于热点数据
  - 分布式缓存（Redis）用于共享数据
  - 实现缓存预热和自动刷新机制
- **任务清单**：
  - [ ] T8-1: 安装配置Redis（0.5人日）
  - [ ] T8-2: 集成Spring Cache框架（0.5人日）
  - [ ] T8-3: 配置Caffeine本地缓存（0.5人日）
  - [ ] T8-4: 配置Redis分布式缓存（0.5人日）
  - [ ] T8-5: 实现缓存键生成策略（1人日）
  - [ ] T8-6: 在关键服务方法上添加缓存注解（1人日）
  - [ ] T8-7: 实现缓存预热机制（1人日）
  - [ ] T8-8: 实现缓存自动刷新机制（1人日）
  - [ ] T8-9: 添加缓存监控和统计（1人日）
  - [ ] T8-10: 进行性能测试和优化（1人日）
- **技术选型**：
  - Spring Cache抽象
  - Caffeine本地缓存
  - Redis分布式缓存
- **预期成果**：
  - 热门查询响应时间降低90%
  - 数据库和计算资源负载降低
  - 系统吞吐量提升
- **负责人**: TBD
- **截止日期**: TBD

## 5. 风险与缓解措施

| 风险 | 影响 | 可能性 | 缓解措施 |
|------|------|--------|----------|
| 重构引入新缺陷 | 高 | 中 | 增加测试覆盖率，实施灰度发布 |
| 架构过度设计 | 中 | 中 | 保持适度复杂度，优先清晰性和可维护性 |
| 安全措施影响易用性 | 中 | 低 | 平衡安全与易用性，提供合理默认配置 |
| 现有功能兼容性 | 高 | 低 | 维护向后兼容性，提供API版本控制 |

## 6. 实施计划与里程碑

### 里程碑计划

| 里程碑 | 预计完成时间 | 包含任务 | 状态 |
|--------|--------------|----------|------|
| M1: 架构基础重构完成 | W2 | T3-1至T3-7, T4-1至T4-7 | 进行中 |
| M2: 安全框架集成完成 | W4 | T1-1至T1-9, T2-1至T2-5 | 部分完成 |
| M3: 容器化与监控完成 | W6 | T5-1至T5-8, T6-1至T6-8 | 未开始 |
| M4: 性能优化完成(可选) | W8 | T7-1至T7-8, T8-1至T8-10 | 未开始 |

### 详细进度计划

#### 阶段一：架构优化（2周）
- 第1周：分层架构分析与设计 (T3-1, T3-2, T3-3, T3-4, T3-5)
- 第2周：设计模式应用与测试 (T3-6, T3-7, T4-1至T4-7)

#### 阶段二：安全加固（2周）
- 第3周：认证授权实现 (T1-1至T1-5) - 已完成
- 第4周：API限流与安全测试 (T1-6至T1-9, T2-1至T2-5)

#### 阶段三：部署与监控（2周）
- 第5周：容器化部署实现 (T5-1至T5-8)
- 第6周：监控系统集成 (T6-1至T6-8)

#### 阶段四：性能优化（按需实施）
- 第7周：并发与异步处理 (T7-1至T7-8)
- 第8周：缓存优化实现 (T8-1至T8-10)

## 7. 资源需求

### 人力资源
- 后端开发工程师：1-2人
- 测试工程师：1人（兼职）
- DevOps工程师：1人（兼职）

### 技术资源
- 开发环境：Docker容器
- 测试环境：模拟生产的测试服务器
- 监控工具：Prometheus + Grafana
- 安全测试工具：OWASP ZAP

## 8. 成功标准

1. 代码结构清晰，符合分层架构
2. 至少实现3种常用设计模式
3. 所有高优先级安全问题已修复
4. 认证授权体系完整实现
5. 测试覆盖率达到80%以上

## 9. 结论

本实施计划调整后更加注重代码质量和架构设计，这对于求职面试和实习申请更具参考价值。优先完成架构优化和设计模式应用，使系统更加健壮、可维护，同时为未来的扩展打下基础。安全加固部分已取得显著进展，后续还将完成简化版的API限流保护。

## 10. 进度跟踪

### 5.1 每周进度报告

| 周次 | 日期 | 完成任务 | 计划任务 | 风险与问题 |
|-----|------|---------|---------|-----------|
| W1 | 2025-07-18 | T1-1至T1-8 | T1-9, T2-1至T2-8 | 安全测试需要更多时间 |
| W2 | 2025-07-25 | T1-9, T3-1至T3-6, T4-1至T4-6 | T3-7, T4-7, T2-1至T2-5 | 设计模式应用需要更多单元测试 |
| W3 | 2025-08-01 |  |  |  |
| W4 | 2025-08-08 |  |  |  |

### 5.2 任务状态汇总

| 模块 | 已完成 | 进行中 | 未开始 | 总计 | 完成率 |
|-----|-------|-------|-------|------|-------|
| 安全加固 | 9 | 0 | 5 | 14 | 64.29% |
| 架构优化 | 12 | 0 | 2 | 14 | 85.71% |
| 容器化部署 | 0 | 0 | 8 | 8 | 0.00% |
| 监控与可观测性 | 0 | 0 | 8 | 8 | 0.00% |
| 性能优化 | 0 | 0 | 8 | 8 | 0.00% |
| 缓存优化 | 0 | 0 | 10 | 10 | 0.00% |
| **总计** | 21 | 0 | 41 | 62 | 33.87% |

## 6. 最新完成任务

### 6.1 单元测试实现
- **完成日期**: 2025-07-25
- **负责人**: 开发团队
- **内容摘要**:
  - 实现了`EmbeddingModelFactoryTest`测试类，验证工厂模式的正确实现
  - 实现了`TextChunkerStrategyTest`测试类，验证策略模式的正确实现
  - 实现了`ServiceDecoratorTest`测试类，验证装饰器模式的正确实现
  - 实现了`DocumentEventTest`测试类，验证观察者模式的正确实现
  - 所有测试均已通过，验证了设计模式的正确实现

### 6.2 设计模式应用
- **完成日期**: 2025-07-25
- **负责人**: 开发团队
- **内容摘要**:
  - 实现了`DefaultRAGService`作为`RAGService`接口的具体实现类
  - 修复了`DJLEmbeddingModel`中的编码问题和异常处理逻辑
  - 优化了装饰器模式的实现，使用构造函数注入被装饰对象
  - 完善了事件系统的实现，添加了更多事件类型和处理逻辑 