# WikiUp 后端架构优化计划

## 1. 当前架构分析

### 1.1 目录结构

```
backend/src/main/java/com/example/ragservice/
├── config/         # 配置类
├── security/       # 安全相关
├── service/        # 服务层
│   └── embedding/  # 嵌入服务相关
├── endpoint/       # 控制器层
├── dto/            # 数据传输对象目录(目前为空)
├── RagServiceApplication.java
└── HealthCheckController.java
```

### 1.2 主要问题

1. **不完整的分层架构**：
   - 缺少清晰的领域模型层
   - 没有明确的Repository层
   - DTO层为空，数据传输结构不规范
   - Controller层使用了"endpoint"命名，不符合Spring Boot惯例

2. **代码组织问题**：
   - 服务类过大，单一职责原则受损
   - 缺少清晰的接口定义，难以实现松耦合
   - 存在内部类定义，应该分离为独立DTO

3. **设计模式应用不足**：
   - 缺少工厂模式管理嵌入模型
   - 缺少策略模式处理不同的文本分块
   - 缺少观察者模式处理异步流程
   - 缺少装饰器模式增强功能

## 2. 优化目标

1. 完善分层架构，提高代码可维护性
2. 运用设计模式解决关键问题
3. 标准化数据传输对象
4. 提高代码复用性和扩展性

## 3. 重构计划

### 3.1 目录结构优化

```
backend/src/main/java/com/example/ragservice/
├── config/         # 配置类
├── controller/     # 控制器层(替代endpoint)
├── dto/            # 数据传输对象
│   ├── request/    # 请求DTO
│   └── response/   # 响应DTO
├── exception/      # 异常处理
├── model/          # 领域模型
├── repository/     # 数据访问层
├── security/       # 安全相关
├── service/        # 服务层
│   ├── impl/       # 服务实现
│   └── embedding/  # 嵌入服务
├── util/           # 工具类
└── RagServiceApplication.java
```

### 3.2 分层架构设计

#### 控制器层 (Controller)
- 职责：处理HTTP请求，参数校验，响应封装
- 核心类:
  - `AdminController` -> 转换为标准RESTful API
  - `ChatController` -> 替代WebSocket的ChatEndpoint
  - `HealthController` -> 移至此目录
  - `DocumentController` -> 新增文档管理接口

#### 数据传输对象 (DTO)
- 职责：封装请求和响应数据
- 核心类:
  - 请求DTO: `ChatRequest`, `DocumentRequest`等
  - 响应DTO: `ChatResponse`, `DocumentResponse`, `ApiResponse<T>`等

#### 服务层 (Service)
- 职责：业务逻辑处理
- 核心接口:
  - `RAGService` -> 定义接口和实现分离
  - `DocumentService` -> 文档处理服务
  - `VectorDBService` -> 向量数据库服务
  - `EmbeddingService` -> 嵌入向量服务

#### 领域模型 (Model)
- 职责：核心业务领域对象
- 核心类:
  - `Document` -> 文档模型
  - `Chunk` -> 文档分块
  - `Embedding` -> 嵌入向量

#### 数据访问层 (Repository)
- 职责：数据持久化
- 核心接口:
  - `DocumentRepository`
  - `VectorRepository`

### 3.3 设计模式应用

#### 工厂模式
- `EmbeddingModelFactory`: 管理不同的嵌入模型
  - 基于配置选择不同的嵌入模型实现

#### 策略模式
- `TextChunker`: 文本分块策略
  - `FixedSizeChunker`: 固定大小分块
  - `SemanticChunker`: 语义感知分块
  - `SlidingWindowChunker`: 滑动窗口分块

#### 观察者模式
- `DocumentProcessingEvent`: 文档处理事件
  - 使用Spring的`ApplicationEvent`机制
  - 处理文档上传、处理、索引等异步流程

#### 装饰器模式
- `ServiceDecorator`: 服务增强装饰器
  - `CachingDecorator`: 添加缓存功能
  - `LoggingDecorator`: 添加日志功能
  - `MetricsDecorator`: 添加指标收集功能

## 4. 具体任务分解

### 4.1 基础架构设置
1. 创建基本目录结构
2. 定义API响应格式标准
3. 创建全局异常处理机制

### 4.2 核心领域模型设计
1. 设计Document领域模型
2. 设计Chunk模型
3. 设计Embedding模型

### 4.3 DTO层实现
1. 创建请求DTO类
2. 创建响应DTO类
3. 创建ModelMapper配置

### 4.4 服务接口定义
1. 定义RAGService接口
2. 定义DocumentService接口
3. 定义VectorDBService接口
4. 定义EmbeddingService接口

### 4.5 设计模式实现
1. 实现EmbeddingModelFactory
2. 实现TextChunker策略
3. 实现文档处理事件机制
4. 实现服务装饰器

### 4.6 控制器改造
1. 重构AdminController
2. 实现RESTful ChatController
3. 规范化API路径和响应格式

### 4.7 测试与质量保障
1. 编写单元测试
2. 编写集成测试
3. 进行代码审查

## 5. 预期收益

1. **可维护性提升**：清晰的分层架构使代码更易理解和维护
2. **可扩展性增强**：模块化设计和松耦合使系统更易扩展
3. **代码质量改善**：遵循设计原则，减少代码臃肿
4. **测试友好**：接口驱动开发使单元测试更加容易
5. **文档完善**：架构规范化使API文档更加完整

## 6. 风险评估

1. **重构引入新缺陷**：通过增加测试覆盖率和审查缓解
2. **性能退化可能**：确保关键路径的性能测试
3. **项目进度影响**：采用渐进式重构，保持功能可用

## 7. 里程碑计划

1. **第一阶段**：基础架构设置和核心领域模型设计 (T3-1, T3-2, T3-3)
2. **第二阶段**：服务接口定义和实现 (T3-4, T3-5)
3. **第三阶段**：设计模式实现 (T4-1至T4-4)
4. **第四阶段**：控制器改造和重构 (T4-5)
5. **第五阶段**：测试与质量保障 (T3-6, T3-7, T4-6, T4-7) 