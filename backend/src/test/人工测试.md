# WikiUp 人工测试指南

## 安全加固模块测试

### 1. Spring Security 与 JWT集成测试

#### 1.1 用户注册测试
- **请求路径**: `POST /api/auth/signup`
- **请求体**:
```json
{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "password123",
  "roles": ["user"]
}
```
- **预期结果**: 返回成功消息，状态码 200
- **测试工具**: Postman 或 curl
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"username":"newuser","email":"newuser@example.com","password":"password123","roles":["user"]}'
```

#### 1.2 用户登录测试
- **请求路径**: `POST /api/auth/signin`
- **请求体**:
```json
{
  "username": "newuser",
  "password": "password123",
  "rememberMe": false
}
```
- **预期结果**: 返回JWT令牌和用户信息，状态码 200
- **测试工具**: Postman 或 curl
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"username":"newuser","password":"password123","rememberMe":false}'
```
- **注意事项**: 保存返回的JWT令牌，用于后续接口测试

#### 1.3 角色访问控制测试

##### 1.3.1 公共接口测试
- **请求路径**: `GET /api/test/all`
- **预期结果**: 返回"公共内容"，状态码 200
- **命令示例**:
```bash
curl http://localhost:8080/api/test/all
```

##### 1.3.2 用户接口测试
- **请求路径**: `GET /api/test/user`
- **请求头**: 需要JWT令牌
- **预期结果**: 返回"用户内容"，状态码 200
- **命令示例**:
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" http://localhost:8080/api/test/user
```

##### 1.3.3 管理员接口测试
- **请求路径**: `GET /api/test/admin`
- **请求头**: 需要JWT令牌（管理员角色）
- **预期结果**: 
  - 普通用户: 返回访问拒绝错误，状态码 403
  - 管理员用户: 返回"管理员内容"，状态码 200
- **测试步骤**:
  1. 使用普通用户令牌测试，预期被拒绝
  2. 使用管理员用户令牌测试，预期成功

##### 1.3.4 超级管理员接口测试
- **请求路径**: `GET /api/test/super`
- **请求头**: 需要JWT令牌（超级管理员角色）
- **预期结果**: 
  - 普通用户/管理员: 返回访问拒绝错误，状态码 403
  - 超级管理员用户: 返回"超级管理员内容"，状态码 200

#### 1.4 权限测试

##### 1.4.1 文档读取权限测试
- **请求路径**: `GET /api/test/docs/read`
- **请求头**: 需要JWT令牌
- **预期结果**: 
  - 所有角色都应能访问，状态码 200
  - 返回"文档读取内容"

##### 1.4.2 文档写入权限测试
- **请求路径**: `GET /api/test/docs/write`
- **请求头**: 需要JWT令牌
- **预期结果**: 
  - 普通用户: 返回访问拒绝错误，状态码 403
  - 管理员和超级管理员: 返回"文档写入内容"，状态码 200

##### 1.4.3 用户删除权限测试
- **请求路径**: `GET /api/test/users/delete`
- **请求头**: 需要JWT令牌
- **预期结果**: 
  - 普通用户和管理员: 返回访问拒绝错误，状态码 403
  - 超级管理员: 返回"用户删除内容"，状态码 200

##### 1.4.4 复合权限测试
- **请求路径**: `GET /api/test/compound`
- **请求头**: 需要JWT令牌
- **预期结果**: 
  - 普通用户: 返回访问拒绝错误，状态码 403
  - 管理员和超级管理员: 返回"复合权限内容"，状态码 200
- **测试目标**: 验证同时需要多个权限的接口控制

### 2. 基于资源的访问控制测试

#### 2.1 获取所有资源测试
- **请求路径**: `GET /api/resources`
- **请求头**: 需要JWT令牌
- **预期结果**: 
  - 普通用户: 返回访问拒绝错误，状态码 403
  - 管理员和超级管理员: 返回资源列表，状态码 200
- **命令示例**:
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" http://localhost:8080/api/resources
```

#### 2.2 获取资源详情测试
- **请求路径**: `GET /api/resources/{id}`
- **请求头**: 需要JWT令牌
- **预期结果**:
  - 非资源拥有者且无权限: 返回访问拒绝错误，状态码 403
  - 资源拥有者或有权限用户: 返回资源详情，状态码 200
- **命令示例**:
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" http://localhost:8080/api/resources/1
```

#### 2.3 创建资源测试
- **请求路径**: `POST /api/resources`
- **请求头**: 需要JWT令牌
- **请求体**:
```json
{
  "type": "DOCUMENT",
  "name": "测试文档",
  "path": "/api/docs/test",
  "description": "测试文档描述",
  "requiresAuth": true
}
```
- **预期结果**:
  - 普通用户: 返回访问拒绝错误，状态码 403
  - 管理员和超级管理员: 返回创建的资源，状态码 200
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/resources \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type":"DOCUMENT","name":"测试文档","path":"/api/docs/test","description":"测试文档描述","requiresAuth":true}'
```

#### 2.4 更新资源测试
- **请求路径**: `PUT /api/resources/{id}`
- **请求头**: 需要JWT令牌
- **请求体**:
```json
{
  "type": "DOCUMENT",
  "name": "更新后的文档",
  "path": "/api/docs/test",
  "description": "更新后的文档描述",
  "requiresAuth": true
}
```
- **预期结果**:
  - 非资源拥有者且无权限: 返回访问拒绝错误，状态码 403
  - 资源拥有者或有权限用户: 返回更新后的资源，状态码 200
- **命令示例**:
```bash
curl -X PUT http://localhost:8080/api/resources/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type":"DOCUMENT","name":"更新后的文档","path":"/api/docs/test","description":"更新后的文档描述","requiresAuth":true}'
```

#### 2.5 删除资源测试
- **请求路径**: `DELETE /api/resources/{id}`
- **请求头**: 需要JWT令牌
- **预期结果**:
  - 非资源拥有者且无权限: 返回访问拒绝错误，状态码 403
  - 资源拥有者或有权限用户: 返回成功，状态码 200
- **命令示例**:
```bash
curl -X DELETE http://localhost:8080/api/resources/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 3. 安全配置测试

#### 3.1 CSRF保护测试
- **测试目标**: 验证CSRF保护是否被正确禁用
- **测试方法**: 使用非浏览器客户端（如Postman）发送POST请求，无需CSRF令牌
- **预期结果**: 请求能够正常处理，不会被CSRF保护拦截

#### 3.2 会话管理测试
- **测试目标**: 验证系统是否使用无状态会话管理
- **测试方法**: 发送请求并检查响应头中是否包含会话Cookie
- **预期结果**: 响应中不应包含JSESSIONID等会话Cookie

### 4. 边界情况测试

#### 4.1 JWT令牌失效测试
- **测试目标**: 验证过期或无效的JWT令牌被正确拒绝
- **测试方法**: 
  1. 使用过期的JWT令牌访问受保护资源
  2. 使用伪造的JWT令牌访问受保护资源
- **预期结果**: 返回认证错误，状态码 401

#### 4.2 密码强度测试
- **测试目标**: 验证密码验证规则是否正确实施
- **测试方法**: 
  1. 尝试使用弱密码注册用户
  2. 尝试使用短密码注册用户
- **预期结果**: 返回密码不符合要求错误

#### 4.3 用户名和邮箱唯一性测试
- **测试目标**: 验证用户名和邮箱唯一性约束
- **测试方法**: 尝试注册已存在的用户名或邮箱
- **预期结果**: 返回用户名或邮箱已存在错误

#### 4.4 资源拥有者特权测试
- **测试目标**: 验证资源拥有者是否拥有操作自己资源的特权
- **测试方法**: 
  1. 用户A创建资源
  2. 用户A尝试修改/删除自己创建的资源
  3. 用户B尝试修改/删除用户A创建的资源
- **预期结果**: 
  - 用户A能成功操作自己的资源，无论其角色权限如何
  - 用户B只有在拥有相应权限时才能操作用户A的资源

### 5. 认证流程增强功能测试

#### 5.1 记住我功能测试
- **请求路径**: `POST /api/auth/signin`
- **请求体**:
```json
{
  "username": "newuser",
  "password": "password123",
  "rememberMe": true
}
```
- **预期结果**: 返回有效期更长的JWT令牌
- **测试方法**: 
  1. 使用rememberMe=false登录，记录令牌有效期
  2. 使用rememberMe=true登录，验证令牌有效期是否更长
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"username":"newuser","password":"password123","rememberMe":true}'
```

#### 5.2 令牌刷新测试
- **请求路径**: `POST /api/auth/refresh`
- **请求头**: 需要JWT令牌
- **预期结果**: 返回新的JWT令牌
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 5.3 获取当前用户信息测试
- **请求路径**: `GET /api/auth/me`
- **请求头**: 需要JWT令牌
- **预期结果**: 返回当前登录用户的信息
- **命令示例**:
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" http://localhost:8080/api/auth/me
```

#### 5.4 修改密码测试
- **请求路径**: `POST /api/auth/change-password`
- **请求头**: 需要JWT令牌
- **请求参数**: 
  - oldPassword: 旧密码
  - newPassword: 新密码
- **预期结果**: 
  - 旧密码正确且新密码符合强度要求: 返回成功消息
  - 旧密码错误: 返回错误消息
  - 新密码不符合强度要求: 返回错误消息
- **命令示例**:
```bash
curl -X POST "http://localhost:8080/api/auth/change-password?oldPassword=password123&newPassword=newpassword123" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 5.5 登录失败保护测试
- **测试目标**: 验证登录失败保护机制是否正常工作
- **测试方法**: 
  1. 连续使用错误密码尝试登录超过阈值次数
  2. 再次尝试登录
- **预期结果**: 
  - 前几次登录失败显示剩余尝试次数
  - 超过阈值后，账户被锁定
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"username":"newuser","password":"wrongpassword","rememberMe":false}'
```

#### 5.6 用户登出测试
- **请求路径**: `POST /api/auth/signout`
- **请求头**: 需要JWT令牌
- **预期结果**: 返回登出成功消息
- **命令示例**:
```bash
curl -X POST http://localhost:8080/api/auth/signout \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 安全审查指南

### 1. 代码安全审查

#### 1.1 输入验证
- **审查内容**:
  - 检查所有用户输入是否进行了适当的验证
  - 是否使用了Bean Validation注解（@NotNull, @Size等）
  - 是否处理了特殊字符和恶意输入
- **审查方法**:
  - 审查所有DTO类的字段验证
  - 检查控制器中对输入参数的处理

#### 1.2 认证机制
- **审查内容**:
  - JWT生成和验证是否安全
  - 密钥是否保护良好
  - 令牌过期时间是否合理
- **审查方法**:
  - 审查JwtTokenUtil类
  - 检查JWT签名算法（应使用HS256或更强算法）
  - 确保密钥长度足够（至少256位）

#### 1.3 授权控制
- **审查内容**:
  - 是否正确实施了基于角色的访问控制
  - 是否实施了细粒度的权限控制
  - 是否保护了敏感操作
- **审查方法**:
  - 审查权限模型和角色定义
  - 检查PreAuthorize注解的使用
  - 验证权限检查的逻辑

#### 1.4 密码处理
- **审查内容**:
  - 密码是否使用强哈希算法存储
  - 是否实施了密码强度验证
  - 密码重置机制是否安全
- **审查方法**:
  - 确认使用了BCryptPasswordEncoder
  - 检查密码验证规则
  - 验证密码存储格式

#### 1.5 敏感数据保护
- **审查内容**:
  - 敏感数据是否加密存储
  - 传输中的数据是否加密
  - 是否避免日志记录敏感信息
- **审查方法**:
  - 检查敏感字段的处理
  - 确认是否使用HTTPS
  - 审查日志配置

### 2. 安全配置审查

#### 2.1 HTTP安全头
- **审查内容**:
  - 是否配置了适当的安全头
  - 是否启用了XSS防护
  - 是否配置了内容安全策略
- **审查方法**:
  - 使用浏览器开发者工具检查响应头
  - 验证X-XSS-Protection, X-Content-Type-Options等头

#### 2.2 跨域设置
- **审查内容**:
  - CORS配置是否安全
  - 是否限制了允许的源
  - 是否限制了HTTP方法和头
- **审查方法**:
  - 检查CorsConfiguration
  - 验证CORS响应头

#### 2.3 错误处理
- **审查内容**:
  - 是否实现了全局异常处理
  - 错误消息是否安全（不泄露敏感信息）
  - 是否区分用户错误和系统错误
- **审查方法**:
  - 检查异常处理器
  - 验证错误响应格式

### 3. 安全测试工具

#### 3.1 OWASP ZAP
- **目的**: 自动化安全测试
- **使用方法**:
  1. 下载并安装OWASP ZAP
  2. 配置代理
  3. 执行自动扫描
  4. 分析和修复发现的问题

#### 3.2 SonarQube
- **目的**: 代码质量和安全性分析
- **使用方法**:
  1. 配置SonarQube扫描
  2. 运行分析
  3. 查看安全性问题报告
  4. 修复高优先级问题

### 4. 安全加固建议

#### 4.1 安全审计日志
- **建议**: 添加全面的安全审计日志
- **实施方法**:
  - 记录所有认证事件（成功和失败）
  - 记录所有访问敏感资源的尝试
  - 记录所有管理操作

#### 4.2 强化密码策略
- **建议**: 实施更强的密码策略
- **实施方法**:
  - 要求至少8个字符长度
  - 要求包含大小写字母、数字和特殊字符
  - 强制定期更改密码

#### 4.3 添加双因素认证
- **建议**: 实施双因素认证
- **实施方法**:
  - 集成Google Authenticator或类似服务
  - 为管理员账户强制使用2FA
  - 为普通用户提供2FA选项

## 测试结果记录表

| 测试ID | 测试名称 | 执行日期 | 执行人 | 测试结果 | 备注 |
|--------|----------|----------|--------|----------|------|
| 1.1    | 用户注册 |          |        |          |      |
| 1.2    | 用户登录 |          |        |          |      |
| 1.3.1  | 公共接口 |          |        |          |      |
| 1.3.2  | 用户接口 |          |        |          |      |
| 1.3.3  | 管理员接口 |        |        |          |      |
| 1.3.4  | 超管接口 |          |        |          |      |
| 1.4.1  | 文档读取权限 |      |        |          |      |
| 1.4.2  | 文档写入权限 |      |        |          |      |
| 1.4.3  | 用户删除权限 |      |        |          |      |
| 1.4.4  | 复合权限测试 |      |        |          |      |
| 2.1    | 获取所有资源 |      |        |          |      |
| 2.2    | 获取资源详情 |      |        |          |      |
| 2.3    | 创建资源 |          |        |          |      |
| 2.4    | 更新资源 |          |        |          |      |
| 2.5    | 删除资源 |          |        |          |      |
| 3.1    | CSRF保护 |          |        |          |      |
| 3.2    | 会话管理 |          |        |          |      |
| 4.1    | JWT令牌失效 |       |        |          |      |
| 4.2    | 密码强度 |          |        |          |      |
| 4.3    | 唯一性约束 |        |        |          |      |
| 4.4    | 资源拥有者特权 |    |        |          |      |
| 5.1    | 记住我功能 |        |        |          |      |
| 5.2    | 令牌刷新 |          |        |          |      |
| 5.3    | 获取当前用户 |      |        |          |      |
| 5.4    | 修改密码 |          |        |          |      |
| 5.5    | 登录失败保护 |      |        |          |      |
| 5.6    | 用户登出 |          |        |          |      | 